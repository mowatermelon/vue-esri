// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper dojo/on ../../../Graphic ../../../core/Accessor ../../../core/Handles ../../../core/Logger ../../../core/accessorSupport/decorators ../../../geometry/Point ../../../symbols/SimpleMarkerSymbol ../lib/glMatrix ../state/utils/viewUtils ../support/aaBoundingRect ../support/debugFlags ../support/debugFlags ../support/earthUtils ../support/mathUtils ../support/projectionUtils ../webgl-engine/Stage ../webgl-engine/lib/Selector ../webgl-engine/lib/Texture".split(" "),
function(U,V,C,t,D,E,F,G,H,r,I,J,g,K,m,L,M,N,p,u,l,O,v){var P=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],Q=H.getLogger("esri.views.3d.OverlayManager"),w,z=function(x){function c(){var a=null!==x&&x.apply(this,arguments)||this;a._handles=new G;a._overlaySR=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._connectedLayers={};a._scale=0;a._dirty=!1;a._isSpherical=!1;a._latestOriginId=0;a.opacity=0;return a}
C(c,x);Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;this._stage=this.view._stage;this._renderer=this._stage.getTextureGraphicsRenderer();this._renderer.onHasHighlightsChanged=function(){return a.onHasHighlightsChanged()};this._initialEmptyTexture=v.createEmpty("initialOverlayTexture");this.groundSelector=new O(this.view.viewingMode);this.groundSelector.enableBackfacesTerrain=
!0;this.groundSelector.enableInvisibleTerrain=!0;this.groundSelector.enableHUDSelection=!1;this._stage.add(l.ModelContentType.TEXTURE,this._initialEmptyTexture);this._handles.add(this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location"],function(){return a.setOverlayDirty()}))};c.prototype.destroy=function(){for(var a in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[a].layerView);this._disposeOverlays();this._stage.remove(l.ModelContentType.TEXTURE,
this._initialEmptyTexture.id);this._handles&&(this._handles.destroy(),this._handles=null)};c.prototype.onHasHighlightsChanged=function(){this.setOverlayDirty();this.notifyChange("hasHighlights")};c.prototype.hasOverlays=function(){return!!this._overlays};c.prototype.setSpatialReference=function(a,b){(this._overlaySR=a)?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._longitudeCyclical=(this._isSpherical=b)?a.isWebMercator?
new p.Cyclical(-2.0037508342788905E7,2.0037508342788905E7):new p.Cyclical(-180,180):null):(this._disposeOverlays(),this._longitudeCyclical=null)};c.prototype.registerLayerView=function(a){var b=this,f=a.layer.uid;if(this._connectedLayers[f])Q.warn("[OverlayManager#registerLayerView]: Layer "+f+" is already connected");else{var d=D(a,"draped-data-change",function(){return b.setOverlayDirty()});this._connectedLayers[f]={eventHandles:[d],layerView:a};if(a.setDrapingExtent&&this._overlays)for(f=0;f<this._overlays.length;f++)d=
this._overlays[f],a.setDrapingExtent(f,d.extent,this._overlaySR,2048,d.renderLocalOrigin);this.setOverlayDirty();this._setLayerViewOverlayUpdating(a,this._dirty)}};c.prototype.unregisterLayerView=function(a){for(var b in this._connectedLayers){var f=this._connectedLayers[b];if(f.layerView===a){if(f.eventHandles)for(var d=0;d<f.eventHandles.length;d++)f.eventHandles[d].remove();delete this._connectedLayers[b];this.setOverlayDirty();a.destroyed||(a._overlayUpdating=!1,a._evaluateUpdatingState())}}};
c.prototype.setOverlayDirty=function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)};c.prototype._setLayerViewOverlayUpdating=function(a,b){if(!b||!a.suspended&&a.hasDraped)a._overlayUpdating=b,a._evaluateUpdatingState()};c.prototype._setOverlayUpdating=function(a){for(var b in this._connectedLayers)this._setLayerViewOverlayUpdating(this._connectedLayers[b].layerView,a);if(b=this.view._graphicsView)b._overlayUpdating=a,b._evaluateUpdatingState()};c.prototype.updateOverlay=function(){if(this._overlaySR){var a=
this._computeOverlayExtents();if(a){this._overlays||this._initOverlays();for(var b=0;b<this._overlays.length;b++){var f=this._overlays[b],d;a:{d=a[b];for(var e=f.extent,c=L.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS?0:z.EXTENTS_DIFFER_THRESHOLD*Math.max(d[2]-d[0],d[3]-d[1],e[2]-e[0],e[3]-e[1]),h=0;4>h;h++)if(Math.abs(e[h]-d[h])>c){d=!0;break a}d=!1}if(d){g.vec4d.set(a[b],f.extent);f.renderLocalOrigin={id:"OV_"+this._latestOriginId++,vec3:m.center(f.extent,g.vec3d.create())};for(var k in this._connectedLayers)d=
this._connectedLayers[k].layerView,d.setDrapingExtent&&d.setDrapingExtent(b,a[b],this._overlaySR,2048,f.renderLocalOrigin)}}this._setOverlayUpdating(!1);this._drawOverlays();this.terrainSurface._updateTileOverlayParams();this._dirty=!1}}};c.prototype.overlaysNeedUpdate=function(){return this._dirty&&!!this._overlaySR};c.prototype.updateOpacity=function(a){var b=1;if(this._overlays){var f=this._scale;a=this.view.renderCoordsHelper.getAltitude(a);3.5*a<f&&(b=Math.sqrt(p.clamp((a-f/10)/(f/3.5-f/10),
0,1)))}return b};c.prototype.setOverlayParamsOfTile=function(a,b,f){var d=a.extent;if(a=this._overlayForTile(a)){var e=a.extent;b.overlayTexScale[0]=(d[2]-d[0])/(e[2]-e[0]);b.overlayTexScale[1]=(d[3]-d[1])/(e[3]-e[1]);var c=d[0];if(this._longitudeCyclical){var c=this._longitudeCyclical.minimalMonotonic(e[0],c),h=this._longitudeCyclical.minimalMonotonic(e[0],d[2]);c>h&&(c=h-(d[2]-d[0]))}g.vec2d.set2((c-e[0])/(e[2]-e[0]),(d[1]-e[1])/(e[3]-e[1]),b.overlayTexOffset);b.overlayTexId=a.valid?a.texture.id:
this._initialEmptyTexture.id;b.highlightOverlayTexId=a.highlightValid?a.highlightTexture.id:this._initialEmptyTexture.id;b.overlayOpacity=void 0!==f?f:1}else b.overlayTexId=null,b.highlightOverlayTexId=null};c.prototype.overlayPixelSizeInMapUnits=function(a){var b;this._overlays&&(this._overlays[0]&&this._pointIsInExtent(a,this._overlays[0].extent)?b=this._overlays[0].extent:this._overlays[1]&&(b=this._overlays[1].extent));return b?(b[2]-b[0])/2048:0};c.prototype._overlayForTile=function(a){var b=
a.extent;a=a.clippingArea?m.intersection(b,a.clippingArea,n):b;return this._rectInsideRect(a,this._overlays[0].extent)?this._overlays[0]:this._rectanglesOverlap(a,this._overlays[1].extent)?this._overlays[1]:null};c.prototype._createEmptyOverlay=function(){var a=new v(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(l.ModelContentType.TEXTURE,a);var b=new v(null,"highlightOverlay",{wrapClamp:!0,mipmap:!0});this._stage.add(l.ModelContentType.TEXTURE,b);return{extent:g.vec4d.create(),texture:a,
valid:!1,highlightTexture:b,highlightValid:!1,renderLocalOrigin:{id:"O",vec3:[0,0,0]}}};c.prototype._initOverlays=function(){this._overlays=[this._createEmptyOverlay(),this._createEmptyOverlay()]};c.prototype._disposeOverlays=function(){if(this._overlays){var a=this._stage;this._overlays.forEach(function(b){a.remove(l.ModelContentType.TEXTURE,b.texture.id);a.remove(l.ModelContentType.TEXTURE,b.highlightTexture.id)});this._overlays=null}};c.prototype._intersectGroundFromView=function(a,b,f,d){var e=
g.vec3d.createFrom(b*this.view.width,f*this.view.height,1);g.vec3d.unproject(e,a.viewMatrix,a.projectionMatrix,a.fullViewport,e);b=g.vec3d.createFrom(b*this.view.width,f*this.view.height,0);g.vec3d.unproject(b,a.viewMatrix,a.projectionMatrix,a.fullViewport,b);this.groundSelector.init([],b,e,null,a,null,!1);this.view.basemapTerrain.intersect(this.groundSelector,b,e);return this.groundSelector.minResult.getIntersectionPoint(d)};c.prototype._findHorizonBasedPointOfInterest=function(a,b,f){var d=.5;if("global"===
this.view.viewingMode){d=g.vec3d.create(a.eye);g.vec3d.normalize(d);g.vec3d.negate(d);b=g.vec3d.length(b);b=Math.asin(b/g.vec3d.length(a.eye));var e=Math.acos(g.vec3d.dot(a.viewForward,d)),d=p.clamp((b-(e-.5*a.fovY))/a.fovY,0,1);b=p.clamp((-b-(e-.5*a.fovY))/a.fovY,0,1);d=1===d&&0===b?.5:b+.55*(d-b)}else d=g.mat4d.multiplyVec4(a.projectionMatrix,g.vec4d.createFrom(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0))[1],d=p.clamp(.5+.5*d,0,1),d=1===d||0===d?.5:0<a.eye[2]?.55*d:1-.55*(1-d);return this._intersectGroundFromView(a,
.5,d,f)?!0:!1};c.prototype._computeOverlayExtents=function(){var a=this.view.state.camera,b=this.terrainSurface.extent,f=g.vec3d.create(),d=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;this._findHorizonBasedPointOfInterest(a,this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,f)||g.vec3d.set(d,f);this._scale=this.view.renderCoordsHelper.getAltitude(a.eye);var e=g.vec3d.dist(a.eye,f),d=K.viewAngle(this.view.renderCoordsHelper,d,a.eye),d=Math.PI/2-Math.abs(d-Math.PI/
2);if(M.OVERLAY_SHOW_CENTER){var c=new J({color:[255,0,0],outline:{color:[255,255,255],width:2}}),h=new I;u.vectorToPoint(f,this._renderSR,h,this._overlaySR);c=new E({geometry:h,symbol:c});void 0!==w&&this.view.graphics.remove(w);this.view.graphics.add(c);w=c}this._overlaySREqualsRenderSR||u.vectorToVector(f,this._renderSR,f,this._overlaySR);c=1024*a.perPixelRatio*e*2;e=!1;h=Infinity;this._isSpherical&&(this._overlaySR.isWebMercator?(c/=Math.cos(u.webMercator.y2lat(f[1])),h=this.terrainSurface.extent[3],
h*=.999):(e=!0,c/=N.metersPerDegree,h=90),c>=h&&(c=h,f[1]=0,this._overlaySR.isWebMercator&&(f[0]=0)));var k=1;e&&(k=1/Math.max(.2,Math.cos(Math.abs(p.deg2rad(f[1])))),180<c*k&&(k=180/c));var l=c*k,q=y[0];q[0]=f[0]-l;q[1]=f[1]-c;q[2]=f[0]+l;q[3]=f[1]+c;this._isSpherical&&this._shiftExtentToFitBounds(q,Infinity,h);e=y[1];g.vec4d.set(q,e);6*l>b[2]-b[0]?g.vec4d.set(b,e):d<=.25*Math.PI?(e[0]-=l,e[1]-=c,e[2]+=l,e[3]+=c):(u.vectorToVector(a.eye,this._renderSR,A,this._overlaySR),g.vec2d.subtract(f,A,n),a=
-Math.atan2(n[1],n[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),g.vec4d.scale(P[Math.floor(a/(.25*Math.PI))],2*c,n),n[0]*=k,n[2]*=k,g.vec4d.add(e,n,e));this._isSpherical&&(e[0]=this._longitudeCyclical.clamp(e[0]),e[2]=this._longitudeCyclical.clamp(e[2]),e[1]=Math.max(e[1],-h),e[3]=Math.min(e[3],h));!this._isSpherical&&b&&(a=m.intersection(q,b,R),b=m.intersection(e,b,S),m.contains(a,b)&&(e[2]=e[0],e[3]=e[1]));this.opacity=1;return y};c.prototype._drawOverlays=function(){for(var a=this._overlays[0].extent[2]-
this._overlays[0].extent[0],b=this._renderer,f=0;f<this._overlays.length;f++){var d=this._overlays[f].extent,e=this._longitudeCyclical?d[2]>this._longitudeCyclical.max:!1,c=this._longitudeCyclical?d[0]<this._longitudeCyclical.min:!1;if(e||c){k.views=T;var c=void 0,c=e?this._longitudeCyclical.max-d[0]:this._longitudeCyclical.min-d[0],c=Math.round(c/(d[2]-d[0])*2048),h=k.views[0];g.vec4d.set4(0,0,c,2048,h.viewport);g.vec4d.set4(d[0],d[1],this._longitudeCyclical.max,d[3],h.extent);e||(h.extent[0]+=this._longitudeCyclical.range);
h=k.views[1];g.vec4d.set4(c,0,2048-c,2048,h.viewport);g.vec4d.set4(this._longitudeCyclical.min,d[1],d[2],d[3],h.extent);e&&(h.extent[2]-=this._longitudeCyclical.range)}else k.views=B,g.vec4d.set(d,k.views[0].extent),g.vec4d.set4(0,0,2048,2048,k.views[0].viewport);k.width=2048;k.height=2048;k.pixelRatio=a/(d[2]-d[0]);this._overlays[f].valid=b.draw(this._overlays[f].texture,k);this._overlays[f].highlightValid=b.drawHighlights(this._overlays[f].highlightTexture,k)}};c.prototype._rectanglesOverlap=function(a,
b){return this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):m.intersects(a,b)};c.prototype._rectInsideRect=function(a,b){return this._longitudeCyclical?this._longitudeCyclical.contains(b[0],b[2],a[0])&&this._longitudeCyclical.contains(b[0],b[2],a[2])&&a[1]>b[1]&&a[3]<b[3]:m.contains(b,a)};c.prototype._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],
b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];var c=a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};c.prototype._shiftExtentToFitBounds=function(a,b,c){var d=0,e=0;a[0]<-b?d=a[0]+b:a[2]>b&&(d=b-a[2]);a[1]<-c?e=a[1]+c:a[3]>c&&(e=c-a[3]);m.offset(a,d,e)};c.EXTENTS_DIFFER_THRESHOLD=1E-5;t([r.property()],c.prototype,"view",void 0);t([r.property()],c.prototype,"terrainSurface",void 0);t([r.property({type:Boolean})],c.prototype,"hasHighlights",null);return c=t([r.subclass("esri.views.3d.terrain.OverlayManager")],c)}(r.declared(F)),
k={width:0,height:0,pixelRatio:0,views:null},B=[{viewport:g.vec4d.create(),extent:g.vec4d.create()}],T=[B[0],{viewport:g.vec4d.create(),extent:g.vec4d.create()}],n=g.vec4d.create(),A=g.vec3d.create(),y=[g.vec4d.create(),g.vec4d.create()],R=m.create(),S=m.create();return z});