// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/throttle","../../support/aaBoundingRect"],function(m,n,l,e){return function(){function a(){this.dirtyExtent=e.create(e.NEGATIVE_INFINITY);this.numPendingSpatialIndexQueries=0;this.elevationDirtyGraphicsQueue=[];this.elevationDirtyGraphicsSet={};this.elevationUpdateEventHandle=null;this.eventHandles=[];this.updateElevation=!1;this.graphicsCore=this.layerView=null;this.markDirtyThrottled=l.throttle(this.markDirty,100,this)}a.prototype.initialize=function(b,
c,a,g){var d=this;this.layerView=b;this.graphicsCore=a;this.elevationProvider=g;this.getGraphicsInExtent=c;this.elevationUpdateEventHandle=g.on("elevation-change",function(b){return d.elevationUpdateHandler(b)});this.eventHandles.push(this.layerView.watch("suspended",function(){return d.suspendedChange()}))};a.prototype.destroy=function(){this.elevationDirtyGraphicsSet=this.elevationDirtyGraphicsQueue=null;this.elevationUpdateEventHandle&&(this.elevationUpdateEventHandle.remove(),this.elevationUpdateEventHandle=
null);this.eventHandles.forEach(function(b){return b.remove()});this.eventHandles=null;this.markDirtyThrottled.remove();this.getGraphicsInExtent=this.graphicsCore=this.layerView=null};a.prototype.clear=function(){this.elevationDirtyGraphicsSet={};this.elevationDirtyGraphicsQueue=[]};a.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&this.markAllGraphicsElevationDirty()};a.prototype.isUpdating=function(){return 0<
this.elevationDirtyGraphicsQueue.length||this.markDirtyThrottled.hasPendingUpdates()||0<this.numPendingSpatialIndexQueries};a.prototype.numNodesUpdating=function(){return this.elevationDirtyGraphicsQueue.length};a.prototype.needsIdleUpdate=function(){return this.elevationProvider&&0<this.elevationDirtyGraphicsQueue.length};a.prototype.idleUpdate=function(b){if(!b.done()){var c=this.layerView.view,a=this.elevationDirtyGraphicsQueue.length;if(0<a){for(var g=this.graphicsCore.stageLayer.id,d=this.graphicsCore.labelStageLayer?
this.graphicsCore.labelStageLayer.id:null,h=0,f=0,f=0;f<a;f++){var e=this.elevationDirtyGraphicsQueue[f],k=this.graphicsCore.graphics[e];k&&k.alignWithElevation(this.elevationProvider,c.renderCoordsHelper);delete this.elevationDirtyGraphicsSet[e];h++;if(20<=h){c._stage.processDirtyLayer(g);null!=d&&c._stage.processDirtyLayer(d);if(b.done())break;h=0}}c._stage.processDirtyLayer(g);null!=d&&c._stage.processDirtyLayer(d);this.elevationDirtyGraphicsQueue.splice(0,f+1);c.deconflictor.setDirty();this.layerView._evaluateUpdatingState()}}};
a.prototype.markAllGraphicsElevationDirty=function(){for(var b in this.graphicsCore.graphics)this.markGraphicElevationDirty(this.graphicsCore.graphics[b].graphic.uid);this.layerView._evaluateUpdatingState()};a.prototype.markGraphicElevationDirty=function(b){this.elevationDirtyGraphicsSet[b]||(this.elevationDirtyGraphicsSet[b]=!0,this.elevationDirtyGraphicsQueue.push(b))};a.prototype.elevationUpdateHandler=function(b){var a=b.extent;this.layerView.suspended?this.updateElevation||(b=this.graphicsCore.computedExtent)&&
a[2]>b.xmin&&a[0]<b.xmax&&a[3]>b.ymin&&a[1]<b.ymax&&(this.updateElevation=!0):(e.expand(this.dirtyExtent,a),this.spatialReference=b.spatialReference,this.markDirtyThrottled(),this.layerView._evaluateUpdatingState())};a.prototype.markDirty=function(){var b=this,a=this.dirtyExtent;-Infinity===a[0]?this.markAllGraphicsElevationDirty():(this.numPendingSpatialIndexQueries++,this.getGraphicsInExtent(a,this.spatialReference,function(a,e){b.numPendingSpatialIndexQueries--;for(var d=0;d<e;d++){var c=a[d],
f=b.graphicsCore.graphics[c];f&&f.needsElevationUpdates()&&b.markGraphicElevationDirty(c)}b.layerView._evaluateUpdatingState()}),this.layerView._evaluateUpdatingState());e.set(this.dirtyExtent,e.NEGATIVE_INFINITY)};return a}()});