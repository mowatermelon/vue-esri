// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/Deferred dojo/sniff dojo/_base/lang dojo/errors/CancelError ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/Version ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),function(Q,n,R,v,A,G,w,H,I,J,B,C,D,K,L,M,N,O){function E(d){return new I("",
"Request for object resource failed: "+d)}function p(d,k){var a,c,q=[],g=[],z=[],x=[],F=[],r=B.Version.parse(d.version||"1.0","wosr");P.validate(r);var r="meshsymbol_"+d.model.name,t=d.textureDefinitions,n={},u;for(u in t){var m=t[u];if(a=m.images[0].data){c=m.encoding+";base64,"+a;a="/textureDefinitions/"+u;var e={noUnpackFlip:!0,wrapClamp:!1};A("enable-feature:jkieboom/alpha-channel-usage")&&(e.wrapClamp=!0);c=new N(c,r,e);F.push(c);n[a]={engineTexObj:c,alphaChannelUsage:"rgba"===m.channels?m.alphaChannelUsage||
"transparency":"none"}}else f.warn("Externally referenced texture data is not yet supported")}u=d.model.geometries;t=d.materialDefinitions;for(m=0;m<u.length;m++){c=e=u[m];var h=c.params,l=h.topology;a=!0;h.vertexAttributes||(f.warn("Geometry must specify vertex attributes"),a=!1);switch(h.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:if(!h.faces)f.warn("Indexed geometries must specify faces"),a=!1;else if(h.vertexAttributes)for(l in l=void 0,h.vertexAttributes){var b=
h.faces[l];b&&b.values?(null!=b.valueType&&"UInt32"!==b.valueType&&(f.warn("Unsupported indexed geometry indices type '"+b.valueType+"', only UInt32 is currently supported"),a=!1),null!=b.valuesPerElement&&1!==b.valuesPerElement&&(f.warn("Unsupported indexed geometry values per element '"+b.valuesPerElement+"', only 1 is currently supported"),a=!1)):(f.warn("Indexed geometry does not specify face indices for '"+l+"' attribute"),a=!1)}break;default:f.warn("Unsupported topology '"+l+"'"),a=!1}c.params.material||
(f.warn("Geometry requires material"),a=!1);c=c.params.vertexAttributes;h=void 0;for(h in c)c[h].values||(f.warn("Geometries with externally defined attributes are not yet supported"),a=!1);if(a){c=e.params;a=c.material;c=c.texture;var l=e.params.vertexAttributes,h={},p;for(p in l)b=l[p],h[p]={data:b.values,size:b.valuesPerElement};z.push([]);l={};if("PerAttributeArray"===e.params.topology){for(var e=h.position.data.length/h.position.size,b=new Uint32Array(e),y=0;y<e;y++)b[y]=y;var e=b,v;for(v in h)l[v]=
e}else for(var w in e.params.faces)l[w]=new Uint32Array(e.params.faces[w].values);e=c?n[c]:null;b=x[a]?x[a][c]:null;b||(b=a.substring(a.lastIndexOf("/")+1),b=t[b].params,1===b.transparency&&(b.transparency=0),b={ambient:b.diffuse,diffuse:b.diffuse,specular:[0,0,0],opacity:1-(b.transparency||0),transparent:0<b.transparency,textureId:e?e.engineTexObj.id:void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:b.externalColorMixMode||"tint"},A("enable-feature:jkieboom/alpha-channel-usage")&&e&&("transparency"===
e.alphaChannelUsage||"maskAndTransparency"===e.alphaChannelUsage)&&(b.transparent=!0),k&&k.materialParamsMixin&&G.mixin(b,k.materialParamsMixin),b=new O(b,r),x[a]||(x[a]={}),x[a][c]=b,g.push(b));z[m].push(b);a=new L(new M(h,l),r);q.push(a)}}return{stageResources:{textures:F,materials:g,geometries:q},materialsByComponent:z,pivotOffset:d.model.pivotOffset}}Object.defineProperty(n,"__esModule",{value:!0});var f=J.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),P=new B.Version(1,1,"wosr");
n.fetch=function(d,k){k=k||{};var a=k.streamDataSupplier;if(a){var c=a.request(d,"json"),q=new v(function(){return a.cancelRequest(c)});c.then(function(a,c){try{var d=p(c,k);return q.resolve(d)}catch(t){return q.reject(t)}},function(a){q.reject(a instanceof w?a:E(a))});return q.promise}var g=H(d),f=new v(function(){return g.cancel()});g.then(function(a){try{var c=p(a.data,k);return f.resolve(c)}catch(r){return f.reject(r)}},function(a){f.reject(a instanceof w?a:E(d))});return f.promise};n.computeBoundingBox=
function(d){d=d.stageResources[K.ModelContentType.GEOMETRY];for(var k=D.create(D.NEGATIVE_INFINITY),a=[0,0,0],c=[0,0,0],f=0;f<d.length;f++){var g=d[f].getBoundingInfo();C.vec3d.set(g.getBBMin(),a);C.vec3d.set(g.getBBMax(),c);for(g=0;3>g;++g)k[g]=Math.min(k[g],a[g]),k[g+3]=Math.max(k[g+3],c[g])}return k};n.createStageResources=p});