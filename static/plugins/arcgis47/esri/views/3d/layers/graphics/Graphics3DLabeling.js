// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports dojo/promise/all ../../../../core/Handles ../../../../core/watchUtils ../../../../layers/support/LabelClass ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DWebStyleSymbol ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextTextureAtlas".split(" "),function(z,A,p,q,r,l,t,u,v,w,x,m,y){return function(){function c(){this.calloutMaterialCollection=this.hudMaterialCollection=this.textTextureAtlas=
null;this.labelVisibilityDirty=!1;this.labelClasses=[];this.eventHandles=new q;this.graphicsCore=this.spatialIndex=this.layer=this.layerView=null}c.prototype.initialize=function(b,a,c,g,f){var d=this;this.layerView=b;this.layer=a;this.spatialIndex=c;this.graphicsCore=g;this.scaleVisibility=f;this.eventHandles.add(r.whenNot(this.layerView,"suspended",function(){return d.resume()}))};c.prototype.destroy=function(){this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&
(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelClasses=null;this.eventHandles.destroy();this.graphicsCore=this.layer=this.layerView=this.eventHandles=null};c.prototype.clear=function(){this.layerView.view.deconflictor.setDirty();this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),
this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null)};c.prototype.updateLabelingInfo=function(){var b=this;this.removeLabels();return this.layer.when(function(){b.scaleVisibility&&b.scaleVisibility.updateScaleRangeActive();var a=b.layer.labelingInfo&&b.layer.labelingInfo.filter(function(a){return!!a.symbol});if(a&&0<a.length){var c=Array(a.length),a=a.map(function(a,f){var d=a.symbol,e;e=b.graphicsCore.getOrCreateGraphics3DSymbol(d);
e=e instanceof v?e.graphics3DSymbol:e;var g=null;t.isCalloutSupport(d)&&d.hasVisibleCallout()&&(g=u.make(d,b.graphicsCore.symbolCreationContext));c[f]={labelClass:a,graphics3DSymbol:e,graphics3DCalloutSymbolLayer:g,options:a.getOptions()};return e});return p(a).then(function(){return c})}return null}).then(function(a){b.labelClasses=a;b.labelVisibilityChanged()})};c.prototype.createLabelsForGraphic=function(b,a){var c=!1;if(this.labelClasses&&0!==this.labelClasses.length&&a._graphics[0]){for(var g=
this.layerLabelsEnabled(),f=0;f<this.labelClasses.length;f++){var d=this.labelClasses[f],e=d.labelClass;if(l.evaluateWhere(e.where,b.attributes)&&(e=e.getLabelExpression(),e.expression)){var n=l.buildLabelText(e.expression,b,this.layer.fields,d.options);if(n){e=null;d.graphics3DSymbol&&d.graphics3DSymbol.symbol&&"label-3d"===d.graphics3DSymbol.symbol.type&&(e=d.graphics3DSymbol.symbol);var k=d.graphics3DSymbol.childGraphics3DSymbols[0],h=w.get({graphic:b,graphics3DGraphic:a,labelSymbol:e,labelClass:d.labelClass});
if(k&&h.isValid){null==this.textTextureAtlas&&(this.textTextureAtlas=new y(this.layer.id,this.layerView.view._stage));null==this.hudMaterialCollection&&(this.hudMaterialCollection=new m(this.layerView.view._stage));f={text:n,centerOffset:h.centerOffset,translation:h.translation,elevationOffset:h.elevationOffset,screenOffset:h.screenOffset,anchor:h.anchor,needsOffsetAdjustment:h.needsOffsetAdjustment,centerOffsetUnits:h.centerOffsetUnits,verticalOffset:h.verticalOffset,debugDrawBorder:x.LABELS_SHOW_BORDER};
if(k=k.createGraphics3DGraphic(b,f,this.hudMaterialCollection,this.textTextureAtlas))k._labelClass=d.labelClass,a.addLabelGraphic(k,this.graphicsCore.labelStageLayer,this.graphicsCore.stage),this.spatialIndex&&!a.addedToSpatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(b,a,this.scaleVisibility.scaleRangeActive())&&this.spatialIndex.addGraphicToSpatialIndex(b,a),a.setVisibilityFlag(0,g,1),a.setVisibilityFlag(1,void 0,1),this.layerView.view.deconflictor.initializeLabelVisibility(a),c=!0,d.graphics3DCalloutSymbolLayer&&
h.hasLabelVerticalOffset&&(null==this.calloutMaterialCollection&&(this.calloutMaterialCollection=new m(this.layerView.view._stage)),(g=d.graphics3DCalloutSymbolLayer.createGraphics3DGraphic(b,{symbol:e,needsOffsetAdjustment:h.needsOffsetAdjustment,translation:f.translation,elevationOffset:f.elevationOffset,screenOffset:f.screenOffset,centerOffset:f.centerOffset,centerOffsetUnits:f.centerOffsetUnits,materialCollection:this.calloutMaterialCollection}))&&a.addLabelGraphic(g,this.graphicsCore.labelStageLayer,
this.graphicsCore.stage));break}}}}c&&this.scaleVisibility&&this.scaleVisibility.updateGraphicLabelScaleVisibility(b,a)}};c.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible};c.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()};c.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()};c.prototype.labelVisibilityChanged=function(){var b=this;if(this.layerView.suspended)this.labelVisibilityDirty=
!0;else if(this.layerView.loadedGraphics){var a=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(c){var g=b.graphicsCore.getGraphics3DGraphicById(c.uid);g&&(a&&0===g._labelGraphics.length&&b.createLabelsForGraphic(c,g),g.setVisibilityFlag(0,a,1))});this.layerView.view.deconflictor.setDirty();this.labelVisibilityDirty=!1}};c.prototype.elevationInfoChange=function(){this.labelClasses&&this.labelClasses.forEach(function(b){b.graphics3DSymbol.layerPropertyChanged("elevationInfo",
{})})};c.prototype.resume=function(){this.labelVisibilityDirty&&this.labelVisibilityChanged()};c.prototype.removeLabels=function(){var b=this;this.layerView.loadedGraphics&&(this.layerView.loadedGraphics.forEach(function(a){if(a=b.graphicsCore.getGraphics3DGraphicById(a.uid))a._labelGraphics&&a._labelGraphics.forEach(function(a){return a._labelClass=null}),a.clearLabelGraphics()}),this.labelClasses=null,this.layerView.view.deconflictor.setDirty())};return c}()});