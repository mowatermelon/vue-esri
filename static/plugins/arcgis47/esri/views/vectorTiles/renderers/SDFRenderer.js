// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports dojo/has ../../../core/libs/gl-matrix/mat4 ../../../core/libs/gl-matrix/vec3 ../../../core/libs/gl-matrix/vec4 ../GeometryUtils ./rendererUtils ./vtShaderSnippets ../../webgl/ShaderVariations ../../webgl/VertexArrayObject".split(" "),function(K,L,F,p,x,y,D,G,H,I,u){var J=1/65536;return function(){function a(){this._attributeLocations={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3};this._attributeLocationsDD={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3,a_color:4,a_size:5};
this._initialized=!1;this._viewProjMat=p.create();this._offsetVector=x.create();this._extrudeMat=p.create();this._haloColor=y.create();this._sdfColor=y.create();this._scaleVec=x.create()}a.prototype.dispose=function(){};a.prototype.render=function(l,d,c,e,a,k,r,f,z,v,A,B,m){var h=this;if(!F("esri-vector-tiles-avoid-text")){this._initialized||this._initialize(l);var x=f.getLayoutValue("text-size",c),y=D.degToByte(a),w=f.getLayoutValue("text-rotation-alignment",c);2===w&&(w=1===f.getLayoutValue("symbol-placement",
c)?0:1);var u=0===w,w=f.getLayoutValue("text-keep-upright",c)&&u;e=3===e;B=.8*3/B;var C=m*f.getPaintValue("text-opacity",c);this._glyphTextureSize||(this._glyphTextureSize=new Float32Array([z.width/4,z.height/4]));m=r.tileTransform.transform;var n=f.getPaintValue("text-translate",c);if(0!==n[0]||0!==n[1]){p.copy(this._viewProjMat,r.tileTransform.transform);m=n[0];var n=n[1],t=0,q=0,q=(1<<r.key.level)/Math.pow(2,c)*(r.coordRange/512);if(1===f.getPaintValue("text-translate-anchor",c)){t=-D.C_DEG_TO_RAD*
a;a=Math.sin(t);var E=Math.cos(t),t=q*(m*E-n*a),q=q*(m*a+n*E)}else t=q*m,q*=n;this._offsetVector[0]=t;this._offsetVector[1]=q;this._offsetVector[2]=0;p.translate(this._viewProjMat,this._viewProjMat,this._offsetVector);m=this._viewProjMat}u?p.copy(this._extrudeMat,v):p.copy(this._extrudeMat,A);this._scaleVec[0]=1/24;this._scaleVec[1]=1/24;this._scaleVec[2]=1;p.scale(this._extrudeMat,this._extrudeMat,this._scaleVec);v=f.hasDataDrivenText;if(A=this._getSDFVAO(l,r,v)){l.bindVAO(A);var b=this._shaderVariations.getProgram([v,
e],void 0,void 0,v?this._attributeLocationsDD:this._attributeLocations);l.bindProgram(b);b.setUniformMatrix4fv("u_transformMatrix",m);b.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat);b.setUniform2fv("u_normalized_origin",r.tileTransform.displayCoord);b.setUniform1f("u_depth",f.z+J);b.setUniform2fv("u_mosaicSize",this._glyphTextureSize);b.setUniform1f("u_mapRotation",y);b.setUniform1f("u_keepUpright",w?1:0);b.setUniform1f("u_level",10*c);b.setUniform1f("u_fadeSpeed",10*k.fadeSpeed);b.setUniform1f("u_minfadeLevel",
10*k.minfadeLevel);b.setUniform1f("u_maxfadeLevel",10*k.maxfadeLevel);b.setUniform1f("u_fadeChange",10*(c+k.fadeChange));b.setUniform1f("u_opacity",C);b.setUniform1i("u_texture",0);b.setUniform1f("u_size",x);b.setUniform1f("u_antialiasingWidth",B);e&&(k=G.int32To4Bytes(d.layerID),b.setUniform4f("u_id",k[0],k[1],k[2],k[3]));d.glyphPerPageElementsMap.forEach(function(d,a){z.bind(l,9729,a,0);var g=f.getPaintValue("text-halo-color",c);a=f.getPaintValue("text-halo-width",c);if(0<g[3]&&0<a){var e=g[3]*
C;h._haloColor[0]=e*g[0];h._haloColor[1]=e*g[1];h._haloColor[2]=e*g[2];h._haloColor[3]=e;g=3*f.getPaintValue("text-halo-blur",c);a*=3;b.setUniform4fv("u_color",h._haloColor);b.setUniform1f("u_halo",1);b.setUniform1f("u_edgeDistance",a);b.setUniform1f("u_edgeBlur",g);l.drawElements(4,d[1],5125,12*d[0])}a=f.getPaintValue("text-color",c);0<a[3]&&(g=a[3]*C,h._sdfColor[0]=g*a[0],h._sdfColor[1]=g*a[1],h._sdfColor[2]=g*a[2],h._sdfColor[3]=g,b.setUniform4fv("u_color",h._sdfColor),b.setUniform1f("u_halo",
0),b.setUniform1f("u_edgeDistance",0),b.setUniform1f("u_edgeBlur",0),l.drawElements(4,d[1],5125,12*d[0]))});l.bindVAO()}}};a.prototype._initialize=function(a){if(this._initialized)return!0;a=new I("text",["textVS","textFS"],[],H,a);a.addDefine("DD","DD",[!0,!1],"DD");a.addDefine("ID","ID",[!0,!0],"ID");this._shaderVariations=a;this._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,
divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]};this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,
normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]};return this._initialized=!0};a.prototype._getSDFVAO=function(a,d,c){if(c){if(d.textDDVertexArrayObject)return d.textDDVertexArrayObject;c=d.textDDVertexBuffer;var e=d.textIndexBuffer;if(!c||!e)return null;d.textDDVertexArrayObject=new u(a,this._attributeLocationsDD,this._vertexAttributesDD,{geometry:c},e);return d.textDDVertexArrayObject}if(d.textVertexArrayObject)return d.textVertexArrayObject;
c=d.textVertexBuffer;e=d.textIndexBuffer;if(!c||!e)return null;d.textVertexArrayObject=new u(a,this._attributeLocations,this._vertexAttributes,{geometry:c},e);return d.textVertexArrayObject};return a}()});