// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define("./Camera ./Util ./gl-matrix ../../../../core/Logger ../../../webgl/Texture ../../../webgl/FramebufferObject ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ../../../webgl/Util".split(" "),function(xa,m,t,aa,ha,ya,za,Aa,Ba,Ca,ia){var b=t.vec2d,H=t.vec3d,ba=t.vec4d,Da=t.mat3d,E=t.mat4d,ja=t.mat4,Ea=aa.getLogger("esri.views.3d.webgl-engine.lib.ShadowMap");return function(t,k){function u(a,b){H.set3(a[b],a[b+3],a[b+6],
ka);return ka}var A=k.gl,v,L=4096,U,ca=new ha(k,{target:A.TEXTURE_2D,pixelFormat:A.RGBA,dataType:A.UNSIGNED_BYTE,samplingMode:A.NEAREST,width:4,height:4}),I=1,da=2,M=[0,0,0,0,0];this.dispose=function(){ca.dispose();ca=null};var e=function(){this.camera=new xa;this.lightMat=E.create()},X=[],n,f,w;for(n=0;4>n;++n)X[n]=new e;this.getIsSupported=function(){return k.extensions.standardDerivatives};this.setTextureResolution=function(a){L=a};this.getTextureResolution=function(){return L};this.setMaxNumCascades=
function(a){da=m.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return da};this.setEnableState=function(a){a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==v};this.getDepthTexture=function(){return v};this.enable=function(){this.getEnableState()||(this.getIsSupported()?(v=new ha(k,{target:A.TEXTURE_2D,pixelFormat:A.RGBA,dataType:A.UNSIGNED_BYTE,wrapMode:A.CLAMP_TO_EDGE,samplingMode:A.NEAREST,flipped:!0,width:L,height:L}),U=ya.createWithAttachments(k,v,{colorTarget:0,
depthStencilTarget:1,width:L,height:L})):Ea.warn("Shadow maps are not supported for this browser or hardware"))};this.disable=function(){this.getEnableState()&&U&&(U.dispose(),v=U=void 0)};var la=E.create(),ma=E.create(),na=ba.create(),x=Array(8);for(n=0;8>n;++n)x[n]=ba.create();var J=H.create(),K=H.create(),oa=b.create(),pa=b.create(),aa=b.create(),qa=b.create(),ra=b.create(),sa=E.create(),ta=H.create();this.prepare=function(z,R,e,r){m.assert(this.getEnableState());E.multiply(z.projectionMatrix,
z.viewMatrix,la);var c=r[0],p=r[1];2>c&&(c=2);2>p&&(p=2);c>=p&&(c=2,p=4);I=Math.min(1+Math.floor(m.logWithBase(p/c,4)),da);e=Math.pow(p/c,1/I);for(r=0;r<I+1;++r)M[r]=c*Math.pow(e,r);E.inverse(la,ma);E.lookAt([0,0,0],[-R[0],-R[1],-R[2]],[0,1,0],sa);e=z.viewMatrix;z=z.projectionMatrix;for(r=0;r<I;++r){var y=X[r],c=-M[r],p=-M[r+1],c=(z[10]*c+z[14])/Math.abs(z[11]*c+z[15]),p=(z[10]*p+z[14])/Math.abs(z[11]*p+z[15]);m.assert(c<p);for(f=0;8>f;++f)for(ba.set4(0===f%4||3==f%4?-1:1,0===f%4||1==f%4?-1:1,4>f?
c:p,1,na),E.multiplyVec4(ma,na,x[f]),w=0;3>w;++w)x[f][w]/=x[f][3];H.negate(x[0],ta);E.translate(sa,ta,y.camera.viewMatrix);for(f=0;8>f;++f)E.multiplyVec3(y.camera.viewMatrix,x[f]);H.set(x[0],J);H.set(x[0],K);for(f=1;8>f;++f)for(w=0;3>w;++w)J[w]=Math.min(J[w],x[f][w]),K[w]=Math.max(K[w],x[f][w]);J[2]-=200;K[2]+=200;y.camera.near=-K[2];y.camera.far=-J[2];c=1/x[0][3];p=1/x[4][3];m.assert(c<p);var h=c+Math.sqrt(c*p),l=Math.sin(Math.acos(e[2]*R[0]+e[6]*R[1]+e[10]*R[2])),h=h/l,c=x,t=h,n=l,l=oa,B=pa,g=aa,
F=qa,h=ra;b.set2(0,0,D);for(var d=void 0,d=0;4>d;++d)b.add(D,c[d],D);b.scale(D,.25);b.set2(0,0,V);for(d=4;8>d;++d)b.add(V,c[d],V);b.scale(V,.25);b.lerp(c[4],c[5],.5,Q[0]);b.lerp(c[5],c[6],.5,Q[1]);b.lerp(c[6],c[7],.5,Q[2]);b.lerp(c[7],c[4],.5,Q[3]);for(var N=0,G=b.dist2(Q[0],D),d=1;4>d;++d){var v=b.dist2(Q[d],D);v<G&&(G=v,N=d)}b.subtract(Q[N],c[N+4],q);d=q[0];q[0]=-q[1];q[1]=d;b.subtract(V,D,ua);b.lerp(q,ua,n);b.normalize(q);N=n=void 0;n=N=b.dot(b.subtract(c[0],D,O),q);for(d=1;8>d;++d)G=b.dot(b.subtract(c[d],
D,O),q),G<n?n=G:G>N&&(N=G);b.set(D,l);b.scale(q,n-t,O);b.add(l,O,l);for(var v=-1,ea=1,d=t=G=0;8>d;++d){b.subtract(c[d],l,Y);b.normalize(Y);var W=q[0]*Y[1]-q[1]*Y[0];0<W?W>v&&(v=W,G=d):W<ea&&(ea=W,t=d)}m.verify(0<v,"leftArea");m.verify(0>ea,"rightArea");b.scale(q,n,S);b.add(S,D,S);b.scale(q,N,T);b.add(T,D,T);Z[0]=-q[1];Z[1]=q[0];B=m.rayRay2D(l,c[t],T,b.add(T,Z,O),1,B);g=m.rayRay2D(l,c[G],T,O,1,g);F=m.rayRay2D(l,c[G],S,b.add(S,Z,O),1,F);c=m.rayRay2D(l,c[t],S,O,1,h);m.verify(B,"rayRay");m.verify(g,"rayRay");
m.verify(F,"rayRay");m.verify(c,"rayRay");g=oa;c=pa;l=qa;F=ra;h=y.camera.projectionMatrix;b.scale(b.subtract(l,F,C),.5);a[0]=C[0];a[1]=C[1];a[2]=0;a[3]=C[1];a[4]=-C[0];a[5]=0;a[6]=C[0]*C[0]+C[1]*C[1];a[7]=C[0]*C[1]-C[1]*C[0];a[8]=1;a[6]=-b.dot(u(a,0),g);a[7]=-b.dot(u(a,1),g);g=b.dot(u(a,0),l)+a[6];B=b.dot(u(a,1),l)+a[7];d=b.dot(u(a,0),F)+a[6];F=b.dot(u(a,1),F)+a[7];g=-(g+d)/(B+F);a[0]+=a[1]*g;a[3]+=a[4]*g;a[6]+=a[7]*g;g=1/(b.dot(u(a,0),l)+a[6]);B=1/(b.dot(u(a,1),l)+a[7]);a[0]*=g;a[3]*=g;a[6]*=g;a[1]*=
B;a[4]*=B;a[7]*=B;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;g=b.dot(u(a,1),c)+a[7];B=b.dot(u(a,2),c)+a[8];d=b.dot(u(a,1),l)+a[7];F=b.dot(u(a,2),l)+a[8];g=-.5*(g/B+d/F);a[1]+=a[2]*g;a[4]+=a[5]*g;a[7]+=a[8]*g;g=b.dot(u(a,1),c)+a[7];B=b.dot(u(a,2),c)+a[8];d=-B/g;a[1]*=d;a[4]*=d;a[7]*=d;h[0]=a[0];h[1]=a[1];h[2]=0;h[3]=a[2];h[4]=a[3];h[5]=a[4];h[6]=0;h[7]=a[5];h[8]=0;h[9]=0;h[10]=1;h[11]=0;h[12]=a[6];h[13]=a[7];h[14]=0;h[15]=a[8];y.camera.projectionMatrix[10]=2/(J[2]-K[2]);y.camera.projectionMatrix[14]=-(J[2]+
K[2])/(J[2]-K[2]);E.multiply(y.camera.projectionMatrix,y.camera.viewMatrix,y.lightMat);c=L/2;y.camera.viewport[0]=0===r%2?0:c;y.camera.viewport[1]=0===Math.floor(r/2)?0:c;y.camera.viewport[2]=c;y.camera.viewport[3]=c}P=void 0;M[I]=100*p;k.bindFramebuffer(U);k.bindTexture(null,7);k.setClearColor(1,1,1,1);k.clear(A.COLOR_BUFFER_BIT|A.DEPTH_BUFFER_BIT);k.setBlendingEnabled(!1)};var fa=[];this.getCascades=function(){for(var a=0;a<I;++a)fa[a]=X[a];fa.length=I;return fa};this.finish=function(a){m.assert(this.getEnableState());
k.bindFramebuffer(a)};this.bind=function(a){var b=this.getEnableState();k.bindTexture(b?v:ca,7);k.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",b?.5/L:-1);a.setUniform1i("shadowMapNum",I);a.setUniform4f("shadowMapDistance",M[0],M[1],M[2],M[3])};this.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};var va=ja.create(),wa=new Float32Array(64),P;this.bindView=function(a,b){if(this.getEnableState()){if(!P||
P[0]!==b[0]||P[1]!==b[1]||P[2]!==b[2]){var e;P=P||H.create();H.set(b,P);for(f=0;f<I;++f)for(ja.translate(X[f].lightMat,b,va),e=0;16>e;++e)wa[16*f+e]=va[e]}a.setUniformMatrix4fv("shadowMapMatrix",wa)}};e=new Float32Array(16);e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=256;e[5]=0;e[6]=1;e[7]=0;e[8]=0;e[9]=256;e[10]=0;e[11]=1;e[12]=256;e[13]=256;e[14]=1;e[15]=1;var ga=new za(k,Ba.Default3D,{geometry:Ca.Pos2Tex},{geometry:Aa.createVertex(k,A.STATIC_DRAW,e)});this.drawDebugQuad=function(a){m.assert(this.getEnableState());
var b=t.get("showDepth");k.setDepthTestEnabled(!1);k.bindProgram(b);b.setUniformMatrix4fv("proj",a);b.setUniform1i("depthTex",0);k.bindTexture(v,0);k.bindVAO(ga);ia.assertCompatibleVertexAttributeLocations(ga,b);k.drawArrays(A.TRIANGLE_STRIP,0,ia.vertexCount(ga,"geometry"));k.setDepthTestEnabled(!0)};var D=b.create(),V=b.create(),Q=[b.create(),b.create(),b.create(),b.create()],q=b.create(),ua=b.create(),O=b.create(),Y=b.create(),S=b.create(),T=b.create(),Z=b.create(),ka=H.create(),C=b.create(),a=
Da.create()}});