// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.6/esri/copyright.txt for details.
//>>built
define(["require","exports","./ModelContentType","./ModelDirtyTypesTs","./Util"],function(B,C,v,D,z){var t=z.objectEmpty,u=z.assert;return function(){function c(a){this._residentGeomRecords={};this._dirtyGeomRecords={};this._dirtyMaterials={};this._model=a}Object.defineProperty(c.prototype,"residentLayerCount",{get:function(){return Object.keys(this._residentGeomRecords).length},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"residentObjectCount",{get:function(){var a=0,b;for(b in this._residentGeomRecords)a+=
Object.keys(this._residentGeomRecords[b]).length;return a},enumerable:!0,configurable:!0});c.prototype._getResidentGeometryRecords=function(){return this._residentGeomRecords};c.prototype._getDirtyGeometryRecords=function(){return this._dirtyGeomRecords};c.prototype.getDirtyMaterials=function(){return t(this._dirtyMaterials)?null:this._dirtyMaterials};c.prototype.clearDirtyMaterials=function(){this._dirtyMaterials={}};c.prototype.hasDirtyGeometryRecords=function(){for(var a in this._dirtyGeomRecords)for(var b in this._dirtyGeomRecords[a]){var d=
this._dirtyGeomRecords[a][b];if(d&&!t(d))return!0}return!1};c.prototype.handleUpdate=function(a,b,d){u(this[b],"ModelDirtySet doesn't know how to process "+b);return this[b](a,d)};c.prototype.shaderTransformationChanged=function(a){if(a=this._residentGeomRecords[a.getId()])for(var b in a){var d=this._model.content[v.OBJECT][b];if(d&&d.hasVolativeTransformation()){var d=a[b],A;for(A in d)for(var c=0,e=d[A][1];c<e.length;c++)e[c].shaderTransformationChanged()}}};c.prototype.getAddRemoveUpdateList=function(a){return this.getAddRemoveUpdateListFilteredByLayers(Object.keys(this._dirtyGeomRecords),
a)};c.prototype.getAddRemoveUpdateListFilteredByLayers=function(a,b){for(var d=[],c=[],f=[],e=0;e<a.length;e++){var h=a[e];if(h in this._dirtyGeomRecords){for(var k in this._dirtyGeomRecords[h]){var n=this._dirtyGeomRecords[h][k];if(n){var l=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,h,k),q;for(q in n){var p=n[q],w=p[0],m=p[1],p=p[2],r=m&2&&p&1;if(m&4||r){var g=l[q];g?c.push.apply(c,g[1]):4===m&&u(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove");b&&g&&delete l[q]}if(m&
1||r){var g=[w,[]],x=this._model.get(v.OBJECT,k);this._model.getGeometryRenderGeometries(x,w,g[1]);d.push.apply(d,g[1]);b&&(l[q]=g)}if(m&2&&!r)if(g=l[q],x=this._model.get(v.OBJECT,k),g){m=g[1];r=m.length;if(p&16)for(g=0;g<r;g++){var y=m[g];this._model.updateRenderGeometryTransformation(x,w,y)}for(g=0;g<r;g++)y=m[g],f.push({renderGeometry:y,updateType:p})}else u(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}t(l)&&delete this._residentGeomRecords[h][k]}}t(this._residentGeomRecords[h])&&
delete this._residentGeomRecords[h]}b&&delete this._dirtyGeomRecords[h]}return[d,c,f]};c.prototype.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers(Object.keys(this._residentGeomRecords))};c.prototype.getResidentRenderGeometriesFilteredByLayers=function(a){for(var b=[],d=0;d<a.length;d++){var c=a[d];if(c in this._residentGeomRecords)for(var f in this._residentGeomRecords[c]){var e=this._residentGeomRecords[c][f];if(e)for(var h in e)b.push.apply(b,e[h][1])}}return b};
c.prototype.componentVisibilityChanged=function(a,b,d){if(null!=b)this._componentPropertyChanged(a,b,d,2);else{b=0;for(var c=a.getGeometryRecords();b<c.length;b++)this._componentPropertyChanged(a,c[b],d,2)}};c.prototype.componentHighlightChanged=function(a,b,d){if(null!=b)this._componentPropertyChanged(a,b,d,32);else{b=0;for(var c=a.getGeometryRecords();b<c.length;b++)this._componentPropertyChanged(a,c[b],d,32)}};c.prototype.vertexAttrsUpdated=function(a,b,d){this._updateOrCreateDirtyRecord(a,b,d,
2,0,0,2,5,4)};c.prototype.colorAttrsUpdated=function(a,b,d){this._updateOrCreateDirtyRecord(a,b,d,2,0,0,2,5,8)};c.prototype.matChanged=function(a){this._dirtyMaterials[a.getId()]=!0};c.prototype.layerAdded=function(a){for(var b=a.getObjects(),d=0;d<b.length;d++)this.layObjectAdded(a,b[d])};c.prototype.layerRemoved=function(a){for(var b=a.getObjects(),d=0;d<b.length;d++)this.layObjectRemoved(a,b[d])};c.prototype.layObjectAdded=function(a,b){a=a.getId();for(var d=b.getGeometryRecords(),c=0;c<d.length;c++)this.objGeometryAdded(b,
d[c],a)};c.prototype.layObjectRemoved=function(a,b){a=a.getId();for(var d=b.getGeometryRecords(),c=0;c<d.length;c++)this.objGeometryRemoved(b,d[c],a)};c.prototype.layObjectReplaced=function(a,b){this.layObjectRemoved(a,b[0]);this.layObjectAdded(a,b[1])};c.prototype.objDirty=function(a,b){b=b||this._getParentLayerId(a);var d=a.getId(),d=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,b,d),c;for(c in d)this._updateOrCreateDirtyRecord(a,d[c][0],b,2,0,2,0,5,1)};c.prototype.objTransformation=
function(a,b){b=b||this._getParentLayerId(a);var d=a.getId(),d=this._createObjectRecordObjIfNonexistent(this._residentGeomRecords,b,d),c;for(c in d)this._updateOrCreateDirtyRecord(a,d[c][0],b,2,0,0,2,5,16)};c.prototype.objGeometryAdded=function(a,b,d){this._updateOrCreateDirtyRecord(a,b,d,1,4,0,0,0)};c.prototype.objGeometryRemoved=function(a,b,d){this._updateOrCreateDirtyRecord(a,b,d,4,1,2,0,0)};c.prototype.objGeometryReplaced=function(a,b){this.objGeometryRemoved(a,b[0]);this.objGeometryAdded(a,
b[1])};c.prototype.objGeometryTransformation=function(a,b){this.objGeometryReplaced(a,b)};c.prototype._componentPropertyChanged=function(a,b,d,c){this._updateOrCreateDirtyRecord(a,b,d,2,0,0,2,5,c)};c.prototype._updateOrCreateDirtyRecord=function(a,b,d,c,f,e,h,k,n){d=d||this._getParentLayerId(a);var l=a.getId();a=b.getId();d=this._createObjectRecordObjIfNonexistent(this._dirtyGeomRecords,d,l);(l=d[a])?(b=l[1],b&f?delete d[a]:b&e?(l[1]=c,l[2]=n):b&h?l[2]|=n:b&k||u(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")):
d[a]=[b,c,n]};c.prototype._createObjectRecordObjIfNonexistent=function(a,b,d){a[b]||(a[b]={});a[b][d]||(a[b][d]={});return a[b][d]};c.prototype._getParentLayerId=function(a){return a.parentLayer.id};c.prototype.formatDebugInfo=function(a){var b=["ADD","UPD",void 0,"REM"];if(a)return"";a="";for(var d in this._dirtyGeomRecords)for(var c in this._dirtyGeomRecords[d]){var f=this._dirtyGeomRecords[d][c];if(f){0<a.length&&(a+="\n");a+=d+"."+c;var e=[],h;for(h in f){var k=f[h][1];e[k]||(e[k]=[]);e[k].push(f[h][0].geometry.id)}for(f=
0;f<e.length;f++)if(e[f])for(a+=" "+b[f-1]+": ",k=0;k<e[f].length;k++)a+=e[f][k]+", "}}return a};return c}()});